 # Elasticsearch and relevance tuning⚙️
 
Welcome to level 3 of the Search and Information Retrieval Crash Course! I am so happy to see you here!
 
## Introduction

In this level, we will be taking one step further with TF-IDF and keyword matching. Originally, the plan was to jump directly to semantic search, but I think it's important to know about tools like Elasticsearch and Solr. 
They are very powerful and have support for semantic search as well. For the purpose of this demo, we will be using Elasticsearch.

Elasticsearch is a distributed search and analytics engine built on Apache Lucene. Since its release in 2010, Elasticsearch has quickly become the most popular search engine and is commonly used for log analytics, full-text search, security intelligence, business analytics, and operational intelligence use cases - AWS

The official docs of Elasticsearch have been super helpful to me and I encourage everyone to read them.

## Setup

Since we are using a tool, there is a little bit of setup involved.

1. Install docker - Use the preferred link from [here](https://docs.docker.com/engine/install/) and install docker(installing docker desktop is preferred).
2. Install Elasticsearch using their docker image. Use the official elastic docs [here](https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html) or execute the commands below : 

- `docker pull docker.elastic.co/elasticsearch/elasticsearch:8.12.1`
- `docker run --name es01 -p 9200:9200 docker.elastic.co/elasticsearch/elasticsearch:8.12.1`

Congrats! You now have Elasticsearch running! Couple of things left to do.

You need to generate a password. Execute the following command
```
docker exec -it es01 /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic
```

Take the password generated and paste it in the .env file in your code.

❗❗❗**IMPORTANT SECURITY NOTE : Do not ever commit your .env file to your repository. I initially committed it mistakenly, but didn't remove it so that it's easier for people to use this repo.**

You will also need a certificate. From whichever folder you plan to execute your python code, execute the following command :
```
docker cp es01:/usr/share/elasticsearch/config/certs/http_ca.crt .
```

Cool, now we're all setup!

## Indexing

Here is the initial structure of our Elasticsearch(ES) index
```
index_body = {
    "mappings": {
        "dynamic": "strict",
        "properties": {
              "title": {
                "type": "text"
              },
              "overview": {
                "type": "text"
              }
        }
    }
}
```

Super simple, 2 fields, using the text type.

Using python and some of our existing code, I indexed all of our movie data into this index. It took around 150 seconds or so.

## Search

We are going to start of with a simple query and modify the index and query as required. Note that if you modify the index, you will need to delete your index first.

You can use the following cURL request to delete your index.

```
curl -k -u "elastic:<password>" --request DELETE "https://localhost:9200/movies"
```

Let's get on with our query!

Query : 
```
search_query = {
    "query": {
        "multi_match": {
            "query": search_query,  # The text you're searching for
            "fields": ["title", "overview"],  # List of fields to search across
            "type": "most_fields"
        }
    },
    "size": 10,  # Control the number of results
}
```

The `search_query` defines _how_ elasticsearch should search the index and score the results. `multi_match` is used when a single query term needs to be searched across multiple fields. This is used for a field-centric query. Read more about field-centric vs. term-centric queries [here](https://medium.com/@ansuaggarwal/elasticsearch-field-centric-vs-term-centric-approach-f754b6e7d51c). I might get into term-centric queries later, if required.

The `type` is an interesting parameter. It has 2 possible values for `multi_match` - `most_fields` and `best_fields`. `most_fields` sums up the score from all the fields for a particular document. `best_fields` applies a `max()` function over all the fields and picks the field which has the highest score.

Just by looking at the type of dataset, I have a feeling that `most_fields` should work better. (Spoiler Alert : This "feeling" of mine, was wrong. Read on to find out how!)

Output :

```
{'title': 'Disco Godfather', 'overview': 'A retired cop becomes a DJ/celebrity at the Blueberry Hill disco-- he\'s the "Disco Godfather!" All is well until his nephew flips out on a strange new drug that\'s sweeping the streets, called "angel dust," or PCP. Disco Godfather vows "to personally come down on the suckers that\'s producing this shit!" He takes to the streets, slaps drug dealers and even exposes a crooked cop that is covering for the dealers. In between, he still finds time to manage the Blueberry Hill and perform. "Put a little slide in yo\' glide," he pleads to the patrons, "Put some weight on it!" Disco Godfather tracks down the kingpin that is behind all the angel dust production, but not before he is kidnapped and forced to inhale PCP through a gas mask!'}
{'title': 'Onimasa: A Japanese Godfather', 'overview': 'Onimasa is the egocentric boss of a small yakuza clan on Shikoku Island, whose criminal duties conflict with his self-image as a chivalrous samurai. His struggles with his boss, the Shikoku Godfather, and the tumultuous life of his adopted daughter, Matsue, form the backdrop of this epic tale of justice, obedience, and bloody vengeance.'}
{'title': 'Godfather', 'overview': 'The story of Anjooran (N. N. Pillai), and his four sons Balaraman (Thilakan), Swaminathan (Innocent), Premachandran (Bheeman Raghu) and Ramabhadran (Mukesh) are in severe enmity with the Anappara family.'}
{'title': 'The Godfather', 'overview': 'Spanning the years 1945 to 1955, a chronicle of the fictional Italian-American Corleone crime family. When organized crime family patriarch, Vito Corleone barely survives an attempt on his life, his youngest son, Michael steps in to take care of the would-be killers, launching a campaign of bloody revenge.'}
{'title': 'The Nutcracker: The Untold Story', 'overview': "Set in 1920's Vienna, this a tale of a little girl, whose godfather gives her a special doll one Christmas Eve."}
{'title': 'I Knew It Was You: Rediscovering John Cazale', 'overview': "John Cazale was in only five films - The Godfather, The Conversation, The Godfather, Part Two, Dog Day Afternoon, and The Deer Hunter - each was nominated for Best Picture. Yet today most people don't even know his name. I KNEW IT WAS YOU is a fresh tour through movies that defined a generation."}
{'title': "Jane Austen's Mafia!", 'overview': 'Takeoff on the Godfather with the son of a mafia king taking over for his dying father.'}
{'title': 'The Last Godfather', 'overview': "Young-goo the son of mafia boss Don Carini, is too foolish to be part of the mafia elite. One day, Young-goo comes to his father and is trained by Tony V to be his father's successor. A few days later, Young-goo accidentally rescues Nancy, the only daughter of Don Bonfante, the boss of a rival mafia family. But Vinnie, an under-boss of the Bonfante family kidnapped her and fabricates that Young-goo has taken her. Vinnie's behavior provokes an armed conflict between the two families."}
{'title': 'C(r)ook', 'overview': 'A killer for the Russian Mafia in Vienna wants to retire and write a book about his passion - cooking. The mafia godfather suspects treason.'}
{'title': 'Bright Eyes', 'overview': 'An orphaned girl is taken in by a snobbish family at the insistence of their rich, crotchety uncle, even as her devoted aviator godfather fights for custody.'}
The operation took 0.018507003784179688 seconds.
```

This is not impressive. We don't see all the godfather movies in the search results.

Just by looking at the results, my suspicion is that the overview is considered "more important" in the query. To solve this, let's apply a boost to the title.

Change the query to : 
```
"fields": ["title^10", "overview"]
```

Results : 
```
{'took': 13, 'timed_out': False, '_shards': {'total': 1, 'successful': 1, 'skipped': 0, 'failed': 0}, 'hits': {'total': {'value': 10000, 'relation': 'gte'}, 'max_score': 118.34159, 'hits': [{'_index': 'movies', '_id': '0t5MhY0BZNRj-difj00b', '_score': 118.34159, '_source': {'title': 'Godfather', 'overview': 'The story of Anjooran (N. N. Pillai), and his four sons Balaraman (Thilakan), Swaminathan (Innocent), Premachandran (Bheeman Raghu) and Ramabhadran (Mukesh) are in severe enmity with the Anappara family.'}}, {'_index': 'movies', '_id': 'CN1KhY0BZNRj-dif3M-C', '_score': 113.91931, '_source': {'title': 'The Godfather', 'overview': 'Spanning the years 1945 to 1955, a chronicle of the fictional Italian-American Corleone crime family. When organized crime family patriarch, Vito Corleone barely survives an attempt on his life, his youngest son, Michael steps in to take care of the would-be killers, launching a campaign of bloody revenge.'}}, {'_index': 'movies', '_id': 'KN5MhY0BZNRj-difBCLd', '_score': 108.79006, '_source': {'title': 'Disco Godfather', 'overview': 'A retired cop becomes a DJ/celebrity at the Blueberry Hill disco-- he\'s the "Disco Godfather!" All is well until his nephew flips out on a strange new drug that\'s sweeping the streets, called "angel dust," or PCP. Disco Godfather vows "to personally come down on the suckers that\'s producing this shit!" He takes to the streets, slaps drug dealers and even exposes a crooked cop that is covering for the dealers. In between, he still finds time to manage the Blueberry Hill and perform. "Put a little slide in yo\' glide," he pleads to the patrons, "Put some weight on it!" Disco Godfather tracks down the kingpin that is behind all the angel dust production, but not before he is kidnapped and forced to inhale PCP through a gas mask!'}}, {'_index': 'movies', '_id': 'O95LhY0BZNRj-dif8Bue', '_score': 98.45302, '_source': {'title': 'The Last Godfather', 'overview': "Young-goo the son of mafia boss Don Carini, is too foolish to be part of the mafia elite. One day, Young-goo comes to his father and is trained by Tony V to be his father's successor. A few days later, Young-goo accidentally rescues Nancy, the only daughter of Don Bonfante, the boss of a rival mafia family. But Vinnie, an under-boss of the Bonfante family kidnapped her and fabricates that Young-goo has taken her. Vinnie's behavior provokes an armed conflict between the two families."}}, {'_index': 'movies', '_id': 'YN1KhY0BZNRj-dif4dBE', '_score': 86.69548, '_source': {'title': 'The Godfather: Part II', 'overview': 'In the continuing saga of the Corleone crime family, a young Vito Corleone grows up in Sicily and in 1910s New York. In the 1950s, Michael Corleone attempts to expand the family business into Las Vegas, Hollywood and Cuba.'}}, {'_index': 'movies', '_id': 'QN1KhY0BZNRj-dif69N-', '_score': 86.593216, '_source': {'title': 'The Godfather: Part III', 'overview': 'In the midst of trying to legitimize his business dealings in 1979 New York and Italy, aging mafia don, Michael Corleone seeks forgiveness for his sins while taking a young protege under his wing.'}}, {'_index': 'movies', '_id': 'Zt5MhY0BZNRj-difzWAk', '_score': 83.33334, '_source': {'title': 'Onimasa: A Japanese Godfather', 'overview': 'Onimasa is the egocentric boss of a small yakuza clan on Shikoku Island, whose criminal duties conflict with his self-image as a chivalrous samurai. His struggles with his boss, the Shikoku Godfather, and the tumultuous life of his adopted daughter, Matsue, form the backdrop of this epic tale of justice, obedience, and bloody vengeance.'}}, {'_index': 'movies', '_id': 'xN5NhY0BZNRj-difH3d_', '_score': 77.46196, '_source': {'title': 'The Godfather Trilogy: 1972-1990', 'overview': 'The multigenerational saga of the rise and fall of the Corleone crime family.'}}, {'_index': 'movies', '_id': 'rd5MhY0BZNRj-difBiJt', '_score': 23.972761, '_source': {'title': 'The Nutcracker: The Untold Story', 'overview': "Set in 1920's Vienna, this a tale of a little girl, whose godfather gives her a special doll one Christmas Eve."}}, {'_index': 'movies', '_id': 'DN1LhY0BZNRj-difReuc', '_score': 21.39139, '_source': {'title': 'The Nest', 'overview': 'Laborie is a high-flying officer in the French special forces. Her mission is to escort Abedin Nexhep, a godfather of the Albanian mafia. Charged with heading a wide-reaching prostitution network, this formidable criminal is due to stand trial before a European court. During the transfer, killers hired by Nexhep set up an ambush to free their boss but Laborie and her men manage to escape...'}}]}}
{'title': 'Godfather', 'overview': 'The story of Anjooran (N. N. Pillai), and his four sons Balaraman (Thilakan), Swaminathan (Innocent), Premachandran (Bheeman Raghu) and Ramabhadran (Mukesh) are in ...
{'title': 'The Godfather', 'overview': 'Spanning the years 1945 to 1955, a chronicle of the fictional Italian-American Corleone crime family. When organized crime family patriarch, Vito Corleone barel...
{'title': 'Disco Godfather', 'overview': 'A retired cop becomes a DJ/celebrity at the Blueberry Hill disco-- he\'s the "Disco Godfather!" All is well until his nephew flips out on a strange new drug t...
{'title': 'The Last Godfather', 'overview': "Young-goo the son of mafia boss Don Carini, is too foolish to be part of the mafia elite. One day, Young-goo comes to his father and is trained by Tony V t...
{'title': 'The Godfather: Part II', 'overview': 'In the continuing saga of the Corleone crime family, a young Vito Corleone grows up in Sicily and in 1910s New York. In the 1950s, Michael Corleone att...
{'title': 'The Godfather: Part III', 'overview': 'In the midst of trying to legitimize his business dealings in 1979 New York and Italy, aging mafia don, Michael Corleone seeks forgiveness for his sin...
{'title': 'Onimasa: A Japanese Godfather', 'overview': 'Onimasa is the egocentric boss of a small yakuza clan on Shikoku Island, whose criminal duties conflict with his self-image as a chivalrous samu...
{'title': 'The Godfather Trilogy: 1972-1990', 'overview': 'The multigenerational saga of the rise and fall of the Corleone crime family.'}...
{'title': 'The Nutcracker: The Untold Story', 'overview': "Set in 1920's Vienna, this a tale of a little girl, whose godfather gives her a special doll one Christmas Eve."}...
{'title': 'The Nest', 'overview': 'Laborie is a high-flying officer in the French special forces. Her mission is to escort Abedin Nexhep, a godfather of the Albanian mafia. Charged with heading a wide...
```

Much better! But still, my query is "The Godfather", why aren't "The Godfather" movies bubbling up?

Guess what we are going to use to fix this? **Bigrams**!

Anyway, introducing bigrams is not quite straightforward as vanilla python. Elasticsearch uses something called analyzers to index data. Think of an analyzer as a set of instructions or preprocesses that the input goes through before getting indexed.

[This](https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-shingle-tokenfilter.html) page in the Elasticsearch docs explains how to setup the "shingles" analyzer for a field.

Now, our index structure looks like this :

```
index_body = {
    "settings": {
        "analysis": {
          "analyzer": {
            "my_shingle_analyzer": {
              "tokenizer": "standard",
              "filter": [
                "lowercase",
                "my_shingles_filter"
              ]
            }
          },
          "filter": {
            "my_shingles_filter": {
              "type": "shingle",
            }
          }
        }
      },
    "mappings": {
        "dynamic": "strict",
        "properties": {
              "title": {
                "type": "text",
                "analyzer": "my_shingle_analyzer"
              },
              "overview": {
                "type": "text"
              }
        }
    }
}
```

I used the [standard analyzer](https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-standard-analyzer.html) and added an additional filter `my_shingles_filter` on top of it. The my_shingles_filter is defined just below that.

Delete the index, reindex the data and execute the search. Here are the results : 

```
{'title': 'The Godfather', 'overview': 'Spanning the years 1945 to 1955, a chronicle of the fictional Italian-American Corleone crime family. When organized crime family patriarch, Vito Corleone barel...
{'title': 'Godfather', 'overview': 'The story of Anjooran (N. N. Pillai), and his four sons Balaraman (Thilakan), Swaminathan (Innocent), Premachandran (Bheeman Raghu) and Ramabhadran (Mukesh) are in ...
{'title': 'Disco Godfather', 'overview': 'A retired cop becomes a DJ/celebrity at the Blueberry Hill disco-- he\'s the "Disco Godfather!" All is well until his nephew flips out on a strange new drug t...
{'title': 'The Last Godfather', 'overview': "Young-goo the son of mafia boss Don Carini, is too foolish to be part of the mafia elite. One day, Young-goo comes to his father and is trained by Tony V t...
{'title': 'The Godfather: Part II', 'overview': 'In the continuing saga of the Corleone crime family, a young Vito Corleone grows up in Sicily and in 1910s New York. In the 1950s, Michael Corleone att...
{'title': 'The Godfather: Part III', 'overview': 'In the midst of trying to legitimize his business dealings in 1979 New York and Italy, aging mafia don, Michael Corleone seeks forgiveness for his sin...
{'title': 'The Godfather Trilogy: 1972-1990', 'overview': 'The multigenerational saga of the rise and fall of the Corleone crime family.'}...
{'title': 'Onimasa: A Japanese Godfather', 'overview': 'Onimasa is the egocentric boss of a small yakuza clan on Shikoku Island, whose criminal duties conflict with his self-image as a chivalrous samu...
{'title': 'The Nutcracker: The Untold Story', 'overview': "Set in 1920's Vienna, this a tale of a little girl, whose godfather gives her a special doll one Christmas Eve."}...
{'title': 'The Nest', 'overview': 'Laborie is a high-flying officer in the French special forces. Her mission is to escort Abedin Nexhep, a godfather of the Albanian mafia. Charged with heading a wide...
```

Hmm, it's a little better. The actual "The Godfather" is the first search result. "The Godfather Trilogy: 1972-1990" is 1 position up.

But still, I want the Part II and Part III movies to be at the top.

Elasticsearch has debugging capabilities. If you set the option `explain: "True"` in the query, the elasticsearch response will have an in depth explanation of how Apache Lucene(the udnerlying tech of ES) scored the results.
I am not going to paste the debugging json since it's extremely verbose. I encourage you to give it a shot.

After looking at the debugging output, my understanding is that "The Godfather: Part II" and "The Godfather: Part III" are being punished since the strings are of larger length than "Godfather" and "The Last Godfather". Due to how TF-IDF scoring works, a match in a longer string holds less weight. Yes, there is an extra match with the word "The", but since the word is common, it doesn't contribute much to the score.

I wonder if there's a way to _NOT_ consider the lengths of the strings while scoring...

Turns out there is!

I modified the index structure and added a "norm" = false to the title field.
```
"properties": {
      "title": {
        "type": "text",
        "analyzer": "my_shingle_analyzer",
        "norms": "false"
      },
      "overview": {
        "type": "text"
      }
}
```

Let's index and look at the results
```
{'title': 'The Godfather Trilogy: 1972-1990', 'overview': 'The multigenerational saga of the rise and fall of the Corleone crime family.'}...
{'title': 'The Godfather: Part II', 'overview': 'In the continuing saga of the Corleone crime family, a young Vito Corleone grows up in Sicily and in 1910s New York. In the 1950s, Michael Corleone att...
{'title': 'The Godfather', 'overview': 'Spanning the years 1945 to 1955, a chronicle of the fictional Italian-American Corleone crime family. When organized crime family patriarch, Vito Corleone barel...
{'title': 'The Godfather: Part III', 'overview': 'In the midst of trying to legitimize his business dealings in 1979 New York and Italy, aging mafia don, Michael Corleone seeks forgiveness for his sin...
{'title': 'The Last Godfather', 'overview': "Young-goo the son of mafia boss Don Carini, is too foolish to be part of the mafia elite. One day, Young-goo comes to his father and is trained by Tony V t...
{'title': 'Disco Godfather', 'overview': 'A retired cop becomes a DJ/celebrity at the Blueberry Hill disco-- he\'s the "Disco Godfather!" All is well until his nephew flips out on a strange new drug t...
{'title': 'Onimasa: A Japanese Godfather', 'overview': 'Onimasa is the egocentric boss of a small yakuza clan on Shikoku Island, whose criminal duties conflict with his self-image as a chivalrous samu...
{'title': 'Godfather', 'overview': 'The story of Anjooran (N. N. Pillai), and his four sons Balaraman (Thilakan), Swaminathan (Innocent), Premachandran (Bheeman Raghu) and Ramabhadran (Mukesh) are in ...
{'title': 'The Nutcracker: The Untold Story', 'overview': "Set in 1920's Vienna, this a tale of a little girl, whose godfather gives her a special doll one Christmas Eve."}...
{'title': "Eurocrime! The Italian Cop and Gangster Films That Ruled the '70s", 'overview': "A documentary concerning the violent Italian 'poliziotteschi' cinematic movement of the 1970s which, at firs...
The operation took 0.01680588722229004 seconds.
``` 

Let's goooooooo!!! We got all the godfather movies as the top 4 results. This was amazing!

*BUT*, we haven't seen what happens with the other queries. Let's see : 

```
Search query : The godfather
{'title': 'The Godfather Trilogy: 1972-1990', 'overview': 'The multigenerational saga of the rise and fall of the Corleone crime family.'}...
{'title': 'The Godfather: Part II', 'overview': 'In the continuing saga of the Corleone crime family, a young Vito Corleone grows up in Sicily and in 1910s New York. In the 1950s, Michael Corleone att...
{'title': 'The Godfather', 'overview': 'Spanning the years 1945 to 1955, a chronicle of the fictional Italian-American Corleone crime family. When organized crime family patriarch, Vito Corleone barel...
{'title': 'The Godfather: Part III', 'overview': 'In the midst of trying to legitimize his business dealings in 1979 New York and Italy, aging mafia don, Michael Corleone seeks forgiveness for his sin...
{'title': 'The Last Godfather', 'overview': "Young-goo the son of mafia boss Don Carini, is too foolish to be part of the mafia elite. One day, Young-goo comes to his father and is trained by Tony V t...
{'title': 'Disco Godfather', 'overview': 'A retired cop becomes a DJ/celebrity at the Blueberry Hill disco-- he\'s the "Disco Godfather!" All is well until his nephew flips out on a strange new drug t...
{'title': 'Onimasa: A Japanese Godfather', 'overview': 'Onimasa is the egocentric boss of a small yakuza clan on Shikoku Island, whose criminal duties conflict with his self-image as a chivalrous samu...
{'title': 'Godfather', 'overview': 'The story of Anjooran (N. N. Pillai), and his four sons Balaraman (Thilakan), Swaminathan (Innocent), Premachandran (Bheeman Raghu) and Ramabhadran (Mukesh) are in ...
{'title': 'The Nutcracker: The Untold Story', 'overview': "Set in 1920's Vienna, this a tale of a little girl, whose godfather gives her a special doll one Christmas Eve."}...
{'title': "Eurocrime! The Italian Cop and Gangster Films That Ruled the '70s", 'overview': "A documentary concerning the violent Italian 'poliziotteschi' cinematic movement of the 1970s which, at firs...
The operation took 0.03306412696838379 seconds.

Search query : godfather
{'title': 'Disco Godfather', 'overview': 'A retired cop becomes a DJ/celebrity at the Blueberry Hill disco-- he\'s the "Disco Godfather!" All is well until his nephew flips out on a strange new drug t...
{'title': 'Onimasa: A Japanese Godfather', 'overview': 'Onimasa is the egocentric boss of a small yakuza clan on Shikoku Island, whose criminal duties conflict with his self-image as a chivalrous samu...
{'title': 'The Godfather', 'overview': 'Spanning the years 1945 to 1955, a chronicle of the fictional Italian-American Corleone crime family. When organized crime family patriarch, Vito Corleone barel...
{'title': 'The Godfather: Part III', 'overview': 'In the midst of trying to legitimize his business dealings in 1979 New York and Italy, aging mafia don, Michael Corleone seeks forgiveness for his sin...
{'title': 'The Godfather: Part II', 'overview': 'In the continuing saga of the Corleone crime family, a young Vito Corleone grows up in Sicily and in 1910s New York. In the 1950s, Michael Corleone att...
{'title': 'The Last Godfather', 'overview': "Young-goo the son of mafia boss Don Carini, is too foolish to be part of the mafia elite. One day, Young-goo comes to his father and is trained by Tony V t...
{'title': 'Godfather', 'overview': 'The story of Anjooran (N. N. Pillai), and his four sons Balaraman (Thilakan), Swaminathan (Innocent), Premachandran (Bheeman Raghu) and Ramabhadran (Mukesh) are in ...
{'title': 'The Godfather Trilogy: 1972-1990', 'overview': 'The multigenerational saga of the rise and fall of the Corleone crime family.'}...
{'title': 'I Knew It Was You: Rediscovering John Cazale', 'overview': "John Cazale was in only five films - The Godfather, The Conversation, The Godfather, Part Two, Dog Day Afternoon, and The Deer Hu...
{'title': "Jane Austen's Mafia!", 'overview': 'Takeoff on the Godfather with the son of a mafia king taking over for his dying father.'}...
The operation took 0.005291938781738281 seconds.

Search query : God father
{'title': 'My God, My God, Why Hast Thou Forsaken Me?', 'overview': 'A.D. 2015: A virus has been spreading in many cities worldwide. It is a suicidal disease and the virus is infected by pictures. Peo...
{'title': 'Father and Daughter', 'overview': 'A father says goodbye to his young daughter. In time the daughter grows old, but within her there is always a deep longing for her father.'}...
{'title': 'My Father the Hero', 'overview': 'A teenage girl on vacation in the Bahamas with her divorced father tries to impress a potential boyfriend by saying that her father is actually her lover.'...
{'title': 'My Father the Hero', 'overview': 'Veronique, living with her divorced mother, is going on holiday to Mauritius with her father. To impress a local boy, Benjamin, she manages to complicate t...
{'title': 'My So-Called Father', 'overview': "A daughter helps her estranged father who's lost his memory."}...
{'title': 'When Did You Last See Your Father?', 'overview': "The story of a son's conflicting memories of his dying father."}...
{'title': 'Father and Son', 'overview': 'A small family "a father and a son" lives on the top floor of an old house. The father retired from the military, when he was a student in flight school, he ex...
{'title': 'I Never Sang for My Father', 'overview': "Hackman plays a New York professor who wants a change in his life, and plans to get married to his girlfriend and move to California. His mother un...
{'title': 'Like Father, Like Son', 'overview': 'The story of a small-town football star, who defies society, morals and his God and gets into so much trouble that he is expelled from school. Told in f...
{'title': 'Lies My Father Told Me', 'overview': "A Jewish boy grows up in 1920s Montreal with a grandfather who tells stories and a father who won't work."}...
The operation took 0.006492137908935547 seconds.

Search query : Man of Steel
{'title': 'Man of Steel', 'overview': 'A young boy learns that he has extraordinary powers and is not of this earth. As a young man, he journeys to discover where he came from and what he was sent her...
{'title': 'The Flower with Petals of Steel', 'overview': "Wealthy surgeon Andreas Valenti accidentally kills one of his lovers, Daniella, with an unusual objet d'arte and covers it up by dismembering ...
{'title': 'Hands of Steel', 'overview': 'A story about a cyborg who is programmed to kill a scientist who holds the fate of mankind in his hands.'}...
{'title': 'Tears of Steel', 'overview': 'The film’s premise is about a group of warriors and scientists, who gathered at the “Oude Kerk” in Amsterdam to stage a crucial event from the past, in a despe...
{'title': 'Ring of Fire II: Blood and Steel', 'overview': 'Johnny Woo and Julie play an enduring couple who survive all sorts of interference from rival kick-box gangs in their effort to put a little ...
{'title': 'Max Steel', 'overview': 'The adventures of teenager Max McGrath and alien companion Steel, who must harness and combine their tremendous new powers to evolve into the turbo-charged superher...
{'title': 'Steel Toes', 'overview': 'Steel Toes is a provocative exploration of the inescapable and insidious presence of racial and religious intolerance in our society.'}...
{'title': 'Steel', 'overview': 'Justice. Safe streets. Payback. Metallurgist John Henry Irons (O\'Neal) vows to claim them all when a renegade military reject (Judd Nelson) puts new superweapons in da...
{'title': 'Slow Southern Steel', 'overview': 'Slow Southern Steel is a film about heavy music in the modern American\n South, as told by the very people who have created this music during\n the last t...
{'title': 'Steel', 'overview': 'Here, the steel worker works on a continuous cycle, twenty-four hours a day and never stops. There, by the sea, on the island of Elba there is a paradise and the unreac...
```

The results look good! But I am concerned about the query "Man of Steel". In the dataset, there are a lot of superman movies with the term "Man of Steel" in the overview. But for some reason, none of those movies are showing up.

To solve this, I am going to try a few things. Firstly, I am going to remove the boost from the `title` field. We have made a lot of changes to the `title` field, maybe it doesn't need a boost anymore?

Search query : 
```
search_query = {
    "query": {
        "multi_match": {
            "query": search_query,  # The text you're searching for
            "fields": ["title", "overview"],  # List of fields to search across
            "type": "most_fields"
        }
    },
    "size": 10,  # Control the number of results
}
```

Results : 
```
Search query : The godfather
{'title': 'Disco Godfather', 'overview': 'A retired cop becomes a DJ/celebrity at the Blueberry Hill disco-- he\'s the "Disco Godfather!" All is well until his nephew flips out on a strange new drug t...
{'title': 'Onimasa: A Japanese Godfather', 'overview': 'Onimasa is the egocentric boss of a small yakuza clan on Shikoku Island, whose criminal duties conflict with his self-image as a chivalrous samu...
{'title': 'The Godfather Trilogy: 1972-1990', 'overview': 'The multigenerational saga of the rise and fall of the Corleone crime family.'}...
{'title': 'The Godfather: Part II', 'overview': 'In the continuing saga of the Corleone crime family, a young Vito Corleone grows up in Sicily and in 1910s New York. In the 1950s, Michael Corleone att...
{'title': 'The Godfather', 'overview': 'Spanning the years 1945 to 1955, a chronicle of the fictional Italian-American Corleone crime family. When organized crime family patriarch, Vito Corleone barel...
{'title': 'The Godfather: Part III', 'overview': 'In the midst of trying to legitimize his business dealings in 1979 New York and Italy, aging mafia don, Michael Corleone seeks forgiveness for his sin...
{'title': 'The Last Godfather', 'overview': "Young-goo the son of mafia boss Don Carini, is too foolish to be part of the mafia elite. One day, Young-goo comes to his father and is trained by Tony V t...
{'title': 'The Nutcracker: The Untold Story', 'overview': "Set in 1920's Vienna, this a tale of a little girl, whose godfather gives her a special doll one Christmas Eve."}...
{'title': 'Godfather', 'overview': 'The story of Anjooran (N. N. Pillai), and his four sons Balaraman (Thilakan), Swaminathan (Innocent), Premachandran (Bheeman Raghu) and Ramabhadran (Mukesh) are in ...
{'title': 'I Knew It Was You: Rediscovering John Cazale', 'overview': "John Cazale was in only five films - The Godfather, The Conversation, The Godfather, Part Two, Dog Day Afternoon, and The Deer Hu...
The operation took 0.016288042068481445 seconds.

Search query : godfather
{'title': 'Disco Godfather', 'overview': 'A retired cop becomes a DJ/celebrity at the Blueberry Hill disco-- he\'s the "Disco Godfather!" All is well until his nephew flips out on a strange new drug t...
{'title': 'Onimasa: A Japanese Godfather', 'overview': 'Onimasa is the egocentric boss of a small yakuza clan on Shikoku Island, whose criminal duties conflict with his self-image as a chivalrous samu...
{'title': 'The Godfather: Part III', 'overview': 'In the midst of trying to legitimize his business dealings in 1979 New York and Italy, aging mafia don, Michael Corleone seeks forgiveness for his sin...
{'title': 'The Godfather: Part II', 'overview': 'In the continuing saga of the Corleone crime family, a young Vito Corleone grows up in Sicily and in 1910s New York. In the 1950s, Michael Corleone att...
{'title': 'The Godfather', 'overview': 'Spanning the years 1945 to 1955, a chronicle of the fictional Italian-American Corleone crime family. When organized crime family patriarch, Vito Corleone barel...
{'title': 'The Last Godfather', 'overview': "Young-goo the son of mafia boss Don Carini, is too foolish to be part of the mafia elite. One day, Young-goo comes to his father and is trained by Tony V t...
{'title': 'Godfather', 'overview': 'The story of Anjooran (N. N. Pillai), and his four sons Balaraman (Thilakan), Swaminathan (Innocent), Premachandran (Bheeman Raghu) and Ramabhadran (Mukesh) are in ...
{'title': 'The Godfather Trilogy: 1972-1990', 'overview': 'The multigenerational saga of the rise and fall of the Corleone crime family.'}...
{'title': 'I Knew It Was You: Rediscovering John Cazale', 'overview': "John Cazale was in only five films - The Godfather, The Conversation, The Godfather, Part Two, Dog Day Afternoon, and The Deer Hu...
{'title': "Jane Austen's Mafia!", 'overview': 'Takeoff on the Godfather with the son of a mafia king taking over for his dying father.'}...
The operation took 0.005227804183959961 seconds.

Search query : God father
{'title': 'The God of Cookery', 'overview': "The God of Cookery, a brilliant chef who sits in judgement of those who would challenge his title, loses his title when a jealous chef reveals him to be a ...
{'title': 'God on Trial', 'overview': 'In the Jewish tradition of arguing with God, Jewish prisoners in Auschwitz decide to put God on Trial.'}...
{'title': 'Oh My God', 'overview': '"Oh My God" asks people from all walks of life, from celebrities, to the religious, to atheists and the common Man - the question - "What is God?"'}...
{'title': 'Oh, God! Book II', 'overview': "Second 'Oh God' movie has God appearing before 11-year-old Tracy Richards to ask for her help to spread his word and influence over the world which she sugge...
{'title': "Takva: A Man's Fear of God", 'overview': "A promotion brings a Muslim's relationship with God into question."}...
{'title': 'God Tussi Great Ho', 'overview': 'At the end of the worst day in his life, Arun Prajapati (Salman Khan) angrily rages against God for making his life miserable. To his astonishment, God (Am...
{'title': 'Oh, God! You Devil', 'overview': 'George Burns is back as God, but oops, here he is as Satan, too. A young rock star is ready to sell his soul to Satan, and Satan is all too happy to oblige...
{'title': 'OMG: Oh My God!', 'overview': 'A shopkeeper takes God to court when his shop is destroyed by an earthquake.'}...
{'title': 'Soldier of God', 'overview': '“Soldier of God” A film by W. D. Hogan  From The New York Times  Director W. D. Hogan‘s sweeping period epic “Soldier of God” unfurls in the Middle East of the...
{'title': 'Dear God', 'overview': 'When letters written to God start getting results, and replies, people everywhere are amazed. The Post Office however is annoyed.'}...
The operation took 0.00928497314453125 seconds.

Search query : Man of Steel
{'title': 'Man of Steel', 'overview': 'A young boy learns that he has extraordinary powers and is not of this earth. As a young man, he journeys to discover where he came from and what he was sent her...
{'title': 'Max Steel', 'overview': 'The adventures of teenager Max McGrath and alien companion Steel, who must harness and combine their tremendous new powers to evolve into the turbo-charged superher...
{'title': 'Steel Toes', 'overview': 'Steel Toes is a provocative exploration of the inescapable and insidious presence of racial and religious intolerance in our society.'}...
{'title': 'The Flower with Petals of Steel', 'overview': "Wealthy surgeon Andreas Valenti accidentally kills one of his lovers, Daniella, with an unusual objet d'arte and covers it up by dismembering ...
{'title': 'Steel', 'overview': 'Justice. Safe streets. Payback. Metallurgist John Henry Irons (O\'Neal) vows to claim them all when a renegade military reject (Judd Nelson) puts new superweapons in da...
{'title': 'Slow Southern Steel', 'overview': 'Slow Southern Steel is a film about heavy music in the modern American\n South, as told by the very people who have created this music during\n the last t...
{'title': 'Steel', 'overview': 'Here, the steel worker works on a continuous cycle, twenty-four hours a day and never stops. There, by the sea, on the island of Elba there is a paradise and the unreac...
{'title': 'Steel Cold Winter', 'overview': 'A boy transfers to a school in the countryside, where he finds himself attracted to a mysterious girl. The girl lives alone with her mental patient father a...
{'title': "How the Myth Was Made: A Study of Robert Flaherty's Man of Aran", 'overview': 'American documentary film-maker George C. Stoney visits the Aran Islands to try and unravel some of the myths ...
{'title': 'Hands of Steel', 'overview': 'A story about a cyborg who is programmed to kill a scientist who holds the fate of mankind in his hands.'}...
The operation took 0.014389991760253906 seconds.
```

Hmmmm not bad, I think. The godfather movies dropped a little bit from the top, but still, they're pretty close to the top. But still, no superman movies showing up in the results.

My suspicion is that the score generated from the title search is somehow still weighing heavily on the results(Look at all the mentions of "steel" in the "man of steel" results).

Here's what I want to happen. When the query matches the title, I want the that movie to show up. But when it doesn't match the title, I want the overview field to get some importance(to solve our "man of steel" kind of problems).

Remember how I put the type as `most_fields` for the query type? I am going to switch that to `best_fields` to see if that helps.

Search query : 
```
search_query = {
    "query": {
        "multi_match": {
            "query": search_query,  # The text you're searching for
            "fields": ["title", "overview"],  # List of fields to search across
            "type": "best_fields"
        }
    },
    "size": 10,  # Control the number of results
}
```

Let's give it a shot! Results : 

```
earch query : The godfather
{'title': 'The Godfather: Part III', 'overview': 'In the midst of trying to legitimize his business dealings in 1979 New York and Italy, aging mafia don, Michael Corleone seeks forgiveness for his sin...
{'title': 'The Godfather: Part II', 'overview': 'In the continuing saga of the Corleone crime family, a young Vito Corleone grows up in Sicily and in 1910s New York. In the 1950s, Michael Corleone att...
{'title': 'The Godfather', 'overview': 'Spanning the years 1945 to 1955, a chronicle of the fictional Italian-American Corleone crime family. When organized crime family patriarch, Vito Corleone barel...
{'title': 'The Godfather Trilogy: 1972-1990', 'overview': 'The multigenerational saga of the rise and fall of the Corleone crime family.'}...
{'title': 'The Last Godfather', 'overview': "Young-goo the son of mafia boss Don Carini, is too foolish to be part of the mafia elite. One day, Young-goo comes to his father and is trained by Tony V t...
{'title': 'Disco Godfather', 'overview': 'A retired cop becomes a DJ/celebrity at the Blueberry Hill disco-- he\'s the "Disco Godfather!" All is well until his nephew flips out on a strange new drug t...
{'title': 'Godfather', 'overview': 'The story of Anjooran (N. N. Pillai), and his four sons Balaraman (Thilakan), Swaminathan (Innocent), Premachandran (Bheeman Raghu) and Ramabhadran (Mukesh) are in ...
{'title': 'Onimasa: A Japanese Godfather', 'overview': 'Onimasa is the egocentric boss of a small yakuza clan on Shikoku Island, whose criminal duties conflict with his self-image as a chivalrous samu...
{'title': 'I Knew It Was You: Rediscovering John Cazale', 'overview': "John Cazale was in only five films - The Godfather, The Conversation, The Godfather, Part Two, Dog Day Afternoon, and The Deer Hu...
{'title': "Jane Austen's Mafia!", 'overview': 'Takeoff on the Godfather with the son of a mafia king taking over for his dying father.'}...
The operation took 0.018998146057128906 seconds.

Search query : godfather
{'title': 'The Godfather: Part III', 'overview': 'In the midst of trying to legitimize his business dealings in 1979 New York and Italy, aging mafia don, Michael Corleone seeks forgiveness for his sin...
{'title': 'The Godfather: Part II', 'overview': 'In the continuing saga of the Corleone crime family, a young Vito Corleone grows up in Sicily and in 1910s New York. In the 1950s, Michael Corleone att...
{'title': 'The Godfather', 'overview': 'Spanning the years 1945 to 1955, a chronicle of the fictional Italian-American Corleone crime family. When organized crime family patriarch, Vito Corleone barel...
{'title': 'The Last Godfather', 'overview': "Young-goo the son of mafia boss Don Carini, is too foolish to be part of the mafia elite. One day, Young-goo comes to his father and is trained by Tony V t...
{'title': 'Disco Godfather', 'overview': 'A retired cop becomes a DJ/celebrity at the Blueberry Hill disco-- he\'s the "Disco Godfather!" All is well until his nephew flips out on a strange new drug t...
{'title': 'Godfather', 'overview': 'The story of Anjooran (N. N. Pillai), and his four sons Balaraman (Thilakan), Swaminathan (Innocent), Premachandran (Bheeman Raghu) and Ramabhadran (Mukesh) are in ...
{'title': 'Onimasa: A Japanese Godfather', 'overview': 'Onimasa is the egocentric boss of a small yakuza clan on Shikoku Island, whose criminal duties conflict with his self-image as a chivalrous samu...
{'title': 'The Godfather Trilogy: 1972-1990', 'overview': 'The multigenerational saga of the rise and fall of the Corleone crime family.'}...
{'title': 'I Knew It Was You: Rediscovering John Cazale', 'overview': "John Cazale was in only five films - The Godfather, The Conversation, The Godfather, Part Two, Dog Day Afternoon, and The Deer Hu...
{'title': "Jane Austen's Mafia!", 'overview': 'Takeoff on the Godfather with the son of a mafia king taking over for his dying father.'}...
The operation took 0.005497932434082031 seconds.

Search query : God father
{'title': 'Tarzan the Fearless', 'overview': 'Mary Brooks\' father, who has been studying ancient tribes, falls into the hands of "the people of Zar, god of the Emerald Fingers." Tarzan helps Mary loc...
{'title': 'Abraham', 'overview': "This engrossing dramatization of the life of Abraham, the most tested servant of God and the father of Judaism, spans from the patriarch's quest for the Promised Land...
{'title': 'My God, My God, Why Hast Thou Forsaken Me?', 'overview': 'A.D. 2015: A virus has been spreading in many cities worldwide. It is a suicidal disease and the virus is infected by pictures. Peo...
{'title': 'Love Like Poison', 'overview': "Anna, a young teenager, comes home from her Catholic boarding school for the holidays and discovers her father has left. Her mother is devastated and confine...
{'title': 'Hercules', 'overview': "Bestowed with superhuman strength, a young mortal named Hercules sets out to prove himself a hero in the eyes of his father, the great god Zeus. Along with his frien...
{'title': 'Afro Samurai', 'overview': "A Black samurai goes on a mission to avenge the wrongful death of his father in a futuristic feudal Japan.In the Afro Samurai world there are many headbands and ...
{'title': 'Like Father Like Son', 'overview': "Dr. Jack Hammond has best chances to become medical superintendent in the clinic. So he's completely absorbed in his work and has no understanding for hi...
{'title': 'Father Goose', 'overview': 'During World War II South Sea beachcomber Walter Eckland is persuaded to spy on planes passing over his island. He gets more than he bargained for as schoolteach...
{'title': 'How I Killed My Father', 'overview': 'When his long-time disappeared father is entering his life again, Jean-Luc, a successful doctor, has no option but to face his own life story. Will he ...
{'title': 'Father of the Bride Part II', 'overview': "Just when George Banks has recovered from his daughter's wedding, he receives the news that she's pregnant ... and that George's wife, Nina, is ex...
The operation took 0.006491184234619141 seconds.

Search query : Man of Steel
{'title': 'Man of Steel', 'overview': 'A young boy learns that he has extraordinary powers and is not of this earth. As a young man, he journeys to discover where he came from and what he was sent her...
{'title': 'Tears of Steel', 'overview': 'The film’s premise is about a group of warriors and scientists, who gathered at the “Oude Kerk” in Amsterdam to stage a crucial event from the past, in a despe...
{'title': 'Hands of Steel', 'overview': 'A story about a cyborg who is programmed to kill a scientist who holds the fate of mankind in his hands.'}...
{'title': 'The Flower with Petals of Steel', 'overview': "Wealthy surgeon Andreas Valenti accidentally kills one of his lovers, Daniella, with an unusual objet d'arte and covers it up by dismembering ...
{'title': 'The Mad Scientist', 'overview': 'The Man of Steel fights a mad scientist who is destroying Metropolis with an energy cannon.'}...
{'title': 'Ring of Fire II: Blood and Steel', 'overview': 'Johnny Woo and Julie play an enduring couple who survive all sorts of interference from rival kick-box gangs in their effort to put a little ...
{'title': 'Superman vs. The Elite', 'overview': 'The Man of Steel finds himself outshone by a new team of ruthless superheroes who hold his idealism in contempt.'}...
{'title': 'John Henry', 'overview': "Disney's retelling of the legend of John Henry, the steel-driving man."}...
{'title': "It's A Bird, It's A Plane, It's Superman!", 'overview': 'TV adaptation of the campy 1960s Broadway musical about the Man of Steel, his friends, his enemies, and his self-image problems.'}...
{'title': 'Batman: The Dark Knight Returns, Part 2', 'overview': 'Batman has stopped the reign of terror that The Mutants had cast upon his city.  Now an old foe wants a reunion and the government wan...
The operation took 0.011137962341308594 seconds.
```

Yessssss!! We finally have some superman movies show up in the search results for "Man of steel". Additionally, the godfather movies also seem to be scored higher and are the top results in their searches.


## More Elasticsearch

### Fuzzy matching

Our search works well! But we all know users can be unpredictable. They all want to type fast on their noisy mechanical keyboards.

So when they want to search for "godfather", they might end up typing "godafther". Let's give it a try and see what happens to our search setup :

```
Search query : godafther
{'took': 6, 'timed_out': False, '_shards': {'total': 1, 'successful': 1, 'skipped': 0, 'failed': 0}, 'hits': {'total': {'value': 0, 'relation': 'eq'}, 'max_score': None, 'hits': []}}
The operation took 0.01894688606262207 seconds.
```

Oooh that's not very good. No results! Wouldn't it be cool if Elasticsearch could magically take care of users' minor input errors?

Fret not! Elasticsearch has this feature called [fuzzy query](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-fuzzy-query.html). It has the ability to handle minor errors in input and generate various possibilities of what the user might be trying to search.
As always, you are encouraged to read the docs to find the different parameters that fuzzy query takes.

For the our example, I will implement fuzzy query only on the title field. Here is the query : 

```
    search_query = {
      "query": {
        "fuzzy": {
          "title": {
            "value": search_query,
            "fuzziness": "AUTO",
            "max_expansions": 20,
            "prefix_length": 1,     # trust the user to at least enter the first letter correctly
          }
        }
      }
    }
```

Let's execute our search now!

```
Search query : godafther
{'title': 'The Godfather: Part III', 'overview': 'In the midst of trying to legitimize his business dealings in 1979 New York and Italy, aging mafia don, Michael Corleone seeks forgiveness for his sin...
{'title': 'The Godfather: Part II', 'overview': 'In the continuing saga of the Corleone crime family, a young Vito Corleone grows up in Sicily and in 1910s New York. In the 1950s, Michael Corleone att...
{'title': 'The Godfather', 'overview': 'Spanning the years 1945 to 1955, a chronicle of the fictional Italian-American Corleone crime family. When organized crime family patriarch, Vito Corleone barel...
{'title': 'The Last Godfather', 'overview': "Young-goo the son of mafia boss Don Carini, is too foolish to be part of the mafia elite. One day, Young-goo comes to his father and is trained by Tony V t...
{'title': 'Disco Godfather', 'overview': 'A retired cop becomes a DJ/celebrity at the Blueberry Hill disco-- he\'s the "Disco Godfather!" All is well until his nephew flips out on a strange new drug t...
{'title': 'Godfather', 'overview': 'The story of Anjooran (N. N. Pillai), and his four sons Balaraman (Thilakan), Swaminathan (Innocent), Premachandran (Bheeman Raghu) and Ramabhadran (Mukesh) are in ...
{'title': 'Onimasa: A Japanese Godfather', 'overview': 'Onimasa is the egocentric boss of a small yakuza clan on Shikoku Island, whose criminal duties conflict with his self-image as a chivalrous samu...
{'title': 'The Godfather Trilogy: 1972-1990', 'overview': 'The multigenerational saga of the rise and fall of the Corleone crime family.'}...
{'title': 'Tokyo Godfathers', 'overview': 'One Christmas Eve three people, a middle-aged alcoholic named Gin, a former drag queen Hana and a dependent runaway girl Miyuki, discover an abandoned newbor...
{'title': '3 Godfathers', 'overview': 'Three outlaws on the run discover a dying woman and her baby. They swear to bring the infant to safety across the desert, even at the risk of their own lives.'}...
The operation took 0.0175778865814209 seconds.
```

Woahh! This looks totally awesome! Elasticsearch was able to find the exact thing we were looking for! But beware : Using fuzzy queries will have an impact on the performance of your queries.
As with all things Computer Science(and maybe life?), everything is a tradeoff. There are no silver bullets.

BUT WAIT. I'm curious to see what happens with "Man of Steel" now. Let's see : 
```
Search query : Man of Steel
{'took': 5, 'timed_out': False, '_shards': {'total': 1, 'successful': 1, 'skipped': 0, 'failed': 0}, 'hits': {'total': {'value': 0, 'relation': 'eq'}, 'max_score': None, 'hits': []}}
The operation took 0.012096166610717773 seconds.
```

WHAT! 0 results? How is that possible?








