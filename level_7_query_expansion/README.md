# Query expansion using semantic Knowledge Graphs

For our search queries so far, we have mostly depended on our search query matching something in our index.
For keyword search, the query had to be an almost match.
For vector search, we depended on the model underneath to understand the context and give vectors closer to itself.

With semantic knowledge graphs, we are going to try something new : Query expansion.

When a user searches for "Man Of Steel", our hope is that something in our title and overview hopefully matches to the query.
But what if we had a way to automatically include a search for the term "Superman" when a user enters "Man of Steel".

Well, one way to do that would be to manually maintain a synonyms list. Obviously, that's tedious and I ain't got time.

So, we'll try to do this automatically. We are going to use an inverted index and a forward index(reverse of inverted index).

The idea is, when a search is triggered, the inverted index gives us a list of documents that the query occurs in.
Then, we use those document IDs to check which word occurs most in those documents. There is a chance, we might find terms
that are similar to each other and can be used for query expansion.

Only 1 way to find out!

## Expanding Queries

We'll use good ol' elasticsearch here to manage indexes.

First, we use the existing libraries that we created to create the movies index.

The good thing is, we don't actually need to create any explicit indexes for this. Elasticsearch has this neat feature 
called [significant text aggregation](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-significanttext-aggregation.html).
It let's you input a search query and gives you related terms to it.

Let's see some examples.

For the query `superman`, we get the words `superman`, `luthor`, `lex`, `krypton`, `batman`, `kryptonite` etc.

This is amazing. By doing very little, elasticsearch is able to give us a list of related words in a relatively small database.

So here's what we're going to do. For each query, we get a set of related terms. Then, we modify our original
elasticsearch search query to include the top 2 related terms and add a feeble boost to it in a should clause.
This adds the terms to the total score of each result but doesn't let the related terms overpower the score 
from our original search query. After all, these are "related" terms.

## Search

Here are some search queries and their results : 

```
Search query : Superman
Expanded query : [{'match': {'overview': {'query': 'luthor', 'boost': 0.3}}}, {'match': {'overview': {'query': 'lex', 'boost': 0.15}}}]
{'title': 'Atom Man vs Superman', 'overview': 'Serial - sequel to Superman (1948); Superman faces off against Lex Luthor.'}...
{'title': 'Batman v Superman: Dawn of Justice', 'overview': 'Fearing the actions of a god-like Super Hero left unchecked, Gotham City’s own formidable, forceful vigilante takes on Metropolis’s most re...
{'title': "The Batman Superman Movie: World's Finest", 'overview': "Joker goes to Metropolis with an offer and plan to kill Superman for Lex Luthor while Batman pursues the clown to Superman's turf"}...
{'title': 'Superman II', 'overview': "Three escaped criminals from the planet Krypton test the Man of Steel's mettle. Led by Gen. Zod, the Kryptonians take control of the White House and partner with ...
{'title': 'All Star Superman', 'overview': 'Lex Luthor enacts his plan to rid the world of Superman, once and for all. Succeeding with solar radiation poisoning, the Man of Steel is slowly dying. With...
{'title': 'Superman Returns', 'overview': 'Superman returns to discover his 5-year absence has allowed Lex Luthor to walk free, and that those he was closest too felt abandoned and have moved on. Luth...
{'title': 'Superman/Batman: Public Enemies', 'overview': 'United States President Lex Luthor uses the oncoming trajectory of a Kryptonite meteor to frame Superman and declare a $1 billion bounty on th...
{'title': 'Superman IV: The Quest for Peace', 'overview': "With global superpowers engaged in an increasingly hostile arms race, Superman leads a crusade to rid the world of nuclear weapons. But Lex L...
{'title': 'Superman', 'overview': "Mild-mannered Clark Kent works as a reporter at the Daily Planet alongside his crush, Lois Lane − who's in love with Superman. Clark must summon his superhero alter ...
{'title': 'Superman: Brainiac Attacks', 'overview': "Embittered by Superman's heroic successes and soaring popularity, Lex Luthor forms a dangerous alliance with the powerful computer/villain Brainiac...
The operation took 0.012296915054321289 seconds.

Search query : The godfather
Expanded query : []
{'title': 'The Godfather Trilogy: 1972-1990', 'overview': 'The multigenerational saga of the rise and fall of the Corleone crime family.'}...
{'title': 'The Godfather: Part II', 'overview': 'In the continuing saga of the Corleone crime family, a young Vito Corleone grows up in Sicily and in 1910s New York. In the 1950s, Michael Corleone att...
{'title': 'The Godfather', 'overview': 'Spanning the years 1945 to 1955, a chronicle of the fictional Italian-American Corleone crime family. When organized crime family patriarch, Vito Corleone barel...
{'title': 'The Godfather: Part III', 'overview': 'In the midst of trying to legitimize his business dealings in 1979 New York and Italy, aging mafia don, Michael Corleone seeks forgiveness for his sin...
{'title': 'The Last Godfather', 'overview': "Young-goo the son of mafia boss Don Carini, is too foolish to be part of the mafia elite. One day, Young-goo comes to his father and is trained by Tony V t...
{'title': 'Disco Godfather', 'overview': 'A retired cop becomes a DJ/celebrity at the Blueberry Hill disco-- he\'s the "Disco Godfather!" All is well until his nephew flips out on a strange new drug t...
{'title': 'I Knew It Was You: Rediscovering John Cazale', 'overview': "John Cazale was in only five films - The Godfather, The Conversation, The Godfather, Part Two, Dog Day Afternoon, and The Deer Hu...
{'title': 'Onimasa: A Japanese Godfather', 'overview': 'Onimasa is the egocentric boss of a small yakuza clan on Shikoku Island, whose criminal duties conflict with his self-image as a chivalrous samu...
{'title': "Jane Austen's Mafia!", 'overview': 'Takeoff on the Godfather with the son of a mafia king taking over for his dying father.'}...
{'title': 'The New Godfathers', 'overview': 'A revolution in Iran halts a heroin shipment, but an alliance of crime families is set on getting it to the US.  They decide to run the drug through an uns...
The operation took 0.013056039810180664 seconds.

Search query : Man of Steel
Expanded query : [{'match': {'overview': {'query': 'man', 'boost': 0.3}}}, {'match': {'overview': {'query': 'luthor', 'boost': 0.15}}}]
{'title': 'Man of Steel', 'overview': 'A young boy learns that he has extraordinary powers and is not of this earth. As a young man, he journeys to discover where he came from and what he was sent her...
{'title': 'John Henry', 'overview': "Disney's retelling of the legend of John Henry, the steel-driving man."}...
{'title': 'The Mad Scientist', 'overview': 'The Man of Steel fights a mad scientist who is destroying Metropolis with an energy cannon.'}...
{'title': 'Superman vs. The Elite', 'overview': 'The Man of Steel finds himself outshone by a new team of ruthless superheroes who hold his idealism in contempt.'}...
{'title': "It's A Bird, It's A Plane, It's Superman!", 'overview': 'TV adaptation of the campy 1960s Broadway musical about the Man of Steel, his friends, his enemies, and his self-image problems.'}...
{'title': 'The Flower with Petals of Steel', 'overview': "Wealthy surgeon Andreas Valenti accidentally kills one of his lovers, Daniella, with an unusual objet d'arte and covers it up by dismembering ...
{'title': 'Superman: Brainiac Attacks', 'overview': "Embittered by Superman's heroic successes and soaring popularity, Lex Luthor forms a dangerous alliance with the powerful computer/villain Brainiac...
{'title': 'Max Steel', 'overview': 'The adventures of teenager Max McGrath and alien companion Steel, who must harness and combine their tremendous new powers to evolve into the turbo-charged superher...
{'title': 'Hands of Steel', 'overview': 'A story about a cyborg who is programmed to kill a scientist who holds the fate of mankind in his hands.'}...
{'title': 'Tears of Steel', 'overview': 'The film’s premise is about a group of warriors and scientists, who gathered at the “Oude Kerk” in Amsterdam to stage a crucial event from the past, in a despe...
The operation took 0.011420965194702148 seconds.

Search query : Steel
Expanded query : [{'match': {'overview': {'query': 'luthor', 'boost': 0.3}}}, {'match': {'overview': {'query': 'kryptonite', 'boost': 0.15}}}]
{'title': 'Max Steel', 'overview': 'The adventures of teenager Max McGrath and alien companion Steel, who must harness and combine their tremendous new powers to evolve into the turbo-charged superher...
{'title': 'Superman: Brainiac Attacks', 'overview': "Embittered by Superman's heroic successes and soaring popularity, Lex Luthor forms a dangerous alliance with the powerful computer/villain Brainiac...
{'title': 'Steel Toes', 'overview': 'Steel Toes is a provocative exploration of the inescapable and insidious presence of racial and religious intolerance in our society.'}...
{'title': 'John Henry', 'overview': "Disney's retelling of the legend of John Henry, the steel-driving man."}...
{'title': 'Rock Star', 'overview': 'Rock Star tells the story of Chris Cole and a rock band called Steel Dragon. Cole is a photocopier technician by day, and the lead singer of a Steel Dragon tribute ...
{'title': 'Steel', 'overview': 'Justice. Safe streets. Payback. Metallurgist John Henry Irons (O\'Neal) vows to claim them all when a renegade military reject (Judd Nelson) puts new superweapons in da...
{'title': 'Slow Southern Steel', 'overview': 'Slow Southern Steel is a film about heavy music in the modern American\n South, as told by the very people who have created this music during\n the last t...
{'title': 'The Mad Scientist', 'overview': 'The Man of Steel fights a mad scientist who is destroying Metropolis with an energy cannon.'}...
{'title': 'All Star Superman', 'overview': 'Lex Luthor enacts his plan to rid the world of Superman, once and for all. Succeeding with solar radiation poisoning, the Man of Steel is slowly dying. With...
{'title': 'Steel', 'overview': 'Here, the steel worker works on a continuous cycle, twenty-four hours a day and never stops. There, by the sea, on the island of Elba there is a paradise and the unreac...
The operation took 0.008802175521850586 seconds.

Search query : Steel
Expanded query : []
{'title': 'Max Steel', 'overview': 'The adventures of teenager Max McGrath and alien companion Steel, who must harness and combine their tremendous new powers to evolve into the turbo-charged superher...
{'title': 'Steel Toes', 'overview': 'Steel Toes is a provocative exploration of the inescapable and insidious presence of racial and religious intolerance in our society.'}...
{'title': 'John Henry', 'overview': "Disney's retelling of the legend of John Henry, the steel-driving man."}...
{'title': 'Rock Star', 'overview': 'Rock Star tells the story of Chris Cole and a rock band called Steel Dragon. Cole is a photocopier technician by day, and the lead singer of a Steel Dragon tribute ...
{'title': 'Steel', 'overview': 'Justice. Safe streets. Payback. Metallurgist John Henry Irons (O\'Neal) vows to claim them all when a renegade military reject (Judd Nelson) puts new superweapons in da...
{'title': 'Slow Southern Steel', 'overview': 'Slow Southern Steel is a film about heavy music in the modern American\n South, as told by the very people who have created this music during\n the last t...
{'title': 'The Mad Scientist', 'overview': 'The Man of Steel fights a mad scientist who is destroying Metropolis with an energy cannon.'}...
{'title': 'Steel', 'overview': 'Here, the steel worker works on a continuous cycle, twenty-four hours a day and never stops. There, by the sea, on the island of Elba there is a paradise and the unreac...
{'title': 'Steel Cold Winter', 'overview': 'A boy transfers to a school in the countryside, where he finds himself attracted to a mysterious girl. The girl lives alone with her mental patient father a...
{'title': 'The Flower with Petals of Steel', 'overview': "Wealthy surgeon Andreas Valenti accidentally kills one of his lovers, Daniella, with an unusual objet d'arte and covers it up by dismembering ...
The operation took 0.006263017654418945 seconds.
```

The results seem decent. The related terms have been boosted by just `0.4` and `0.2` respectively for the top 2 terms.
My focus was on the last 2 searches. Again, we need to make sure that the scores from the additional terms do not envelope
the scores from the original query terms. 

The second last search is with query expansion. Here we can see a larger impact 
of Superman movies in a query of `Steel` since most mentions of Steel in the overview section of dataset are accompanied by Superman.
The last search is `Steel` without query expansion. Notice far fewer Superman related results.

The difference between the results of the last 2 queries is a problem. I'm not going to fix it right now since I am focussing
on covering as many techniques as possible and not trying to build the "ideal" movie search application. My suspicion is,
this dataset doesn't even require query expansion for the title and overview field. If we had included actors, directors and other staff,
it would have been interesting to see which words closely related to a person, for example Tarantino. Next time, i guess!

